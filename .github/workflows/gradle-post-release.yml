name: Maven Post Release Workflow

on:
  workflow_call:
    inputs:
      app-version:
        description: Application version to release
        required: true
        type: string
      java-distribution:
        description: The Java Distribution to use, default 'adopt-hotspot'
        required: false
        type: string
        default: adopt-hotspot
      java-version:
        description: The Java Version to use, default '8'
        required: false
        type: string
        default: 8
      main-branch:
        description: Main branch reference
        required: false
        type: string
        default: refs/heads/main
      pr-reviewers:
        description: Users to be included on the post-release pull request
        required: false
        type: string
        default: adesjardin, manikmagar, kkingavio
    outputs:
      app-version:
        description: The new application version
        value: ${{ jobs.Build-With-Maven.outputs.version }}

jobs:
  Prepare-Next-Snapshot:
    runs-on: ubuntu-latest
    if: ${{ !contains(inputs.app-version, 'SNAPSHOT') && github.event_name != 'pull_request' && github.ref == inputs.main-branch }}

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: '0'
          submodules: 'recursive'

      - name: Set up JDK 1.8
        uses: actions/setup-java@v3
        with:
          distribution: ${{ inputs.java-distribution }}
          java-version: ${{ inputs.java-version }}
          cache: gradle

      - name: Increment Version
        if: ${{ !contains(steps.set-version.outputs.version, 'SNAPSHOT') && github.event_name != 'pull_request' && github.ref == inputs.main-branch }}
        run: ./gradlew incrementPatch -Dversion.prerelease=SNAPSHOT

      - name: Set New Version Variable
        if: ${{ !contains(steps.set-version.outputs.version, 'SNAPSHOT') && github.event_name != 'pull_request' && github.ref == inputs.main-branch }}
        id: set-new-version
        run: echo "version=$(./gradlew mule-linter-core:properties -q | grep "version:" | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: ${{ !contains(steps.set-version.outputs.version, 'SNAPSHOT') && github.event_name != 'pull_request' && github.ref == inputs.main-branch }}
        uses: peter-evans/create-pull-request@v4
        with:
          branch: "chore/v${{ steps.set-new-version.outputs.version }}"
          commit-message: "chore: [create-pull-request]  Auto increment to v${{ steps.set-new-version.outputs.version }}"
          title: "chore: Auto increment to v${{ steps.set-new-version.outputs.version }}"
          delete-branch: true
          assignees: ${{ github.actor }}
          reviewers: ${{ inputs.pr-reviewers }}
